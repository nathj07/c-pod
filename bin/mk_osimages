#!/usr/bin/env ruby
#
# Download and mount the disk images
# Create appropriate links
#
require 'optparse'
require 'fileutils'

base = File.absolute_path('../..', File.dirname(__FILE__))
arch = 'x86_64'
mirror='http://centos.mirror.freedomvoice.com'
force = false

OptionParser.new do |opts|
    opts.banner = "Script to download, mount and link OS distributions"

    opts.on( '-?', '--help', 'Display this screen' ) do
        puts opts
        exit
    end
    opts.on('-f', '--[no]-force', "Remove and re-create existing links") do |m|
	force = m
    end
    opts.on('-m', '--mirror', String, "The CentOS mirror site to use (default: #{mirror}") do |m|
	mirror = m
    end
    opts.parse!
    if ARGV.size > 0
	puts opts.help 
	exit 2
    end
end

unless Process.euid == 0 
    puts "Hey - you need to run this as root"
    exit 2
end

versionset = {
    '5.9' => { 1 => 'bin-DVD-1of2', 2 => 'bin-DVD-2of2', 'net' => 'netinstall' },
#    '6.3' => { 1 => 'bin-DVD1', 2 => 'bin-DVD2', 'net' => 'netinstall', 'min' => 'minimal'},
    '6.4' => { 1 => 'bin-DVD1', 2 => 'bin-DVD2', 'net' => 'netinstall', 'min' => 'minimal'}
} 

versionset.keys.each do |version|
    versionset[version].each do |shortname,name|
	imagefile = "CentOS-#{version}-#{arch}-#{name}.iso"
	FileUtils.cd "#{base}/isos"
	unless File.exist? imagefile
		puts "Downloading #{imagefile}..."
		`curl -O -# #{mirror}/#{version}/isos/#{arch}/#{imagefile}`
	end
	FileUtils.mkdir_p "#{base}/osdisks/centos#{version}-#{shortname}"
	`mount -o loop -t iso9660 #{base}/isos/#{imagefile} #{base}/osdisks/centos#{version}-#{shortname}` unless shortname.is_a? Integer
    end
    # Now make the consolidated distribution directories

    targetdir = "#{base}/osdisks/centos#{version}"
    FileUtils.mkdir_p targetdir
    versionset[version].keys.select{|k| k.is_a? Integer}.sort.each do |shortname|
	name = versionset[version][shortname]
	imagefile = "CentOS-#{version}-#{arch}-#{name}.iso"
	srcdir = "#{base}/osdisks/centos#{version}-#{shortname}"
	`mount -o loop -t iso9660 #{base}/isos/#{imagefile} #{srcdir}`
	cmd = "rsync -rltd --exclude='*.i[356]86.rpm' #{targetdir}-#{shortname}/* #{targetdir}"
	puts cmd
	res = `#{cmd}`
	puts res if $? != 0
	`umount #{srcdir}`
    end
end

# vim: set sts=4 sw=4 ts=8:
