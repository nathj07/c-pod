#!/usr/bin/env ruby
#
# Push a package to the YUM repo
# The server-side CGI rebuilds the yum indices
#
require 'fileutils'
require 'optparse'
require 'ostruct'
require 'resolv'

def info msg
    print "\033[32m#{msg}\033[0m"
end

types = [:stable, :unstable, :lifted]

opts = OpenStruct.new(type: :unstable, debug: false, force: nil, repo: ENV['CPOD'] || 'c-pod.local')

OptionParser.new do |o|
    o.banner = "usage: #{o.program_name} [options] pkg ..."
    o.separator "Push RPM and GEM packages to C-Pod server and rebuild indices. Options:"

    o.on( '-?', '--help', 'Display this screen' ) do
        STDERR.puts o
        exit
    end
    o.on('-d', '--debug', "Debug") do
        opts.debug = true
    end
    o.on('-t', '--type TYPE', types, "Type: #{types.join(', ')} (default: #{opts.type})") do |t|
        opts.type = t
    end
    o.on('-r', '--repo HOST', "The C-Pod server (default #{opts.repo})") do |n|
        opts.repo = n
    end
    o.on('-f', '--force', "Force complete metadata rebuild") do
        opts.force = true
    end
    o.parse! rescue (puts "Error: #{$!}"; puts o; exit)
    if ARGV.size == 0 and not opts.force
        STDERR.puts o
        exit
    end
end

if opts.repo.end_with? '.local'
    mdns = Resolv::MDNS.new rescue nil
    if mdns
        mdns.each_address(opts.repo) do |a|
            opts.repo = a.to_s if a.is_a? Resolv::IPv4
        end
    else
        puts "You need Ruby 2.1 for .local names to work!"
        exit
    end
end

base = File.absolute_path('../..', File.dirname(__FILE__))
curlopts = ["-F type=#{opts.type}"]
curlopts.push "-F debug=yes" if opts.debug
curlopts.push "-F force=yes" if opts.force

info "Using C-Pod #{opts.repo}\n"
files = ARGV.select { |f| File.exist?(f) ? true: ( puts "File #{f} not found"; false ) }
files.each do |f|
    info "Uploading #{f}\n"
    cmd = "curl -f -# -w '%{http_code}' #{curlopts.join(' ')} -F pkgfile=@#{f} http://#{opts.repo}/bin/rx_pkg.cgi"
    puts `#{cmd}`
end

info "Rebuilding Indices\n"
curlopts.push("-F rebuild=yes")
system("curl -f --silent #{curlopts.join(' ')} http://#{opts.repo}/bin/rx_pkg.cgi")

# vim: sts=4 sw=4 ts=8
