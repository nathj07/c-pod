#!/usr/bin/env ruby
# Setup the Repo webserver
# * Directories
# * Apache configuration
# * Permissions
#
require 'fileutils'
require 'erb'

base = File.absolute_path('../..', File.dirname(__FILE__))

begin
    # Setup the GEM repository directories
    #
    FileUtils.mkdir_p "#{base}/gem_repo"
    FileUtils.mkdir_p "#{base}/gem_repo/gems"

    # Setup the YUM repository directories
    #
    FileUtils.mkdir_p "#{base}/yum_repos/epel/5/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/epel/5/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/epel/6/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/epel/6/x86_64"

    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/stable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/stable/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/unstable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/unstable/x86_64"

    FileUtils.ln_sf "#{base}/yum_repos/custom/5", "#{base}/yum_repos/custom/5Server"

    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/stable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/stable/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/unstable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/unstable/x86_64"

    FileUtils.ln_sf "#{base}/yum_repos/custom/6", "#{base}/yum_repos/custom/6Server"

    # Setup the other directories
    #
    FileUtils.mkdir_p "#{base}/downloads"
    FileUtils.mkdir_p "#{base}/osdisks"
    FileUtils.mkdir_p "#{base}/isos"

    # Link the Apache config
    #

    comment = "Generated from the file #{base}/repo/repo.conf"
    erb = ERB.new(File.open("#{base}/repo/repo.conf.erb", "r", &:read))
    File.open("/etc/httpd/conf.d/_repo.conf", "w") { |f| f.write erb.result(binding) }

    FileUtils.chown_R(nil, 'apache', "/etc/httpd/conf.d/")
    FileUtils.chmod("g+w", "/etc/httpd/conf.d/_repo.conf")
    FileUtils.chown_R(nil, 'apache', "#{base}/")

rescue Exception => ex
    puts "Problem creating directories: #{ex.message}"
    puts ex.backtrace[0..3].join("\n")
    exit 2
end
# vim: sts=4 sw=4 ts=8
