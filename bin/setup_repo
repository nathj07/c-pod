#!/usr/bin/env ruby
# Setup the Repo webserver
# * Directories
# * Apache configuration
# * Permissions
#
require 'fileutils'
require 'erb'

repo = File.absolute_path('..', File.dirname(__FILE__))
base = File.absolute_path('../..', File.dirname(__FILE__))
File.umask(0002)

unless Process.euid == 0
    puts "Hey - you need to run this as root"
    exit 2
end

begin
    # Setup the GEM repository directories
    #
    FileUtils.mkdir_p "#{base}/gem_repo/gems"

    # Setup the YUM repository directories
    #
    FileUtils.mkdir_p "#{base}/yum_repos/lifted/5/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/lifted/5/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/lifted/6/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/lifted/6/x86_64"

    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/stable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/stable/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/unstable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/5/unstable/x86_64"

    FileUtils.ln_s("#{base}/yum_repos/custom/5", "#{base}/yum_repos/custom/5Server") \
	    unless File.exist? "#{base}/yum_repos/custom/5Server"

    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/stable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/stable/x86_64"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/unstable/noarch"
    FileUtils.mkdir_p "#{base}/yum_repos/custom/6/unstable/x86_64"

    FileUtils.ln_s "#{base}/yum_repos/custom/6", "#{base}/yum_repos/custom/6Server" \
	    unless File.exist? "#{base}/yum_repos/custom/6Server"

    # Setup the other directories
    #
    FileUtils.mkdir_p "#{base}/cookbooks"
    FileUtils.ln_sf   "#{base}/c-pod/chef/cookbooks/c-pod", "#{base}/cookbooks/c-pod" unless File.exist? "#{base}/cookbooks/c-pod"
    FileUtils.mkdir_p "#{base}/downloads"
    FileUtils.mkdir_p "#{base}/osdisks"
    FileUtils.mkdir_p "#{base}/isos"

    # Setup permissions
    #
    FileUtils.chown_R('c-pod', 'c-pod', base)
    `chmod -R g+rw #{base}/*`
    `find #{base}/yum_repos -type d -exec chmod 2770 {} \\;`
    `find #{base}/yum_repos -type f -exec chmod 660 {} \\;`

    # Add GEMS
    #
    %w{redcarpet builder}.each do |name|
	system "gem install #{name}" unless require name
    end
rescue Exception => ex
    puts "Problem creating directories: #{ex.message}"
    puts ex.backtrace.join("\n")
    exit 2
end
# vim: sts=4 sw=4 ts=8
